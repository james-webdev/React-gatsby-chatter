steps:
- name: 'gendall/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/app:$TAG_NAME', '.']

- name: 'gendall/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/app:$TAG_NAME']

- name: 'gendall/terraform'
  args: ['init', '-backend-config=bucket=$PROJECT_ID-terraform', '-backend-config=prefix=$_ENV']

- name: 'gendall/terraform'
  args: ['apply', '-var=project=$PROJECT_ID', '-var=env=$_ENV', '-var=output=inventory']
  secretEnv: ['GOOGLE_CREDENTIALS', 'DIGITALOCEAN_TOKEN', 'CLOUDFLARE_EMAIL', 'CLOUDFLARE_TOKEN', 'CLOUDFLARE_API_KEY', 'SSH_KEY']

- name: 'gendall/ansible'
  args: ['-i', 'inventory/hosts', 'deploy.yml']
  env: ['PROJECT_ID=$PROJECT_ID', 'TAG_NAME=$TAG_NAME', 'ENV=$_ENV']
  secretEnv: ['VAULT_ADDR', 'VAULT_TOKEN', 'SSH_KEY']

secrets:
- kmsKeyName: 'projects/gendall-447f96/locations/global/keyRings/cloudbuild/cryptoKeys/auth'
  secretEnv:
    GOOGLE_CREDENTIALS: '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'
    DIGITALOCEAN_TOKEN: 'CiQA3c2SSOHsIaHI+GK+fQzOBDneoaVDaxOzWtBuZ+XJkJMUzR8SaAAp5JKpp3LryldbyzYQcsFkDQZx+kFVXTm6+QtzgT5g40tS28gDIW4AEzueU4+DvPdqNsceGkRu81p8pkQ3uzy1LacpWft8eJ+yrAq96hhKwuIWd6YJ95AX2MCXpgnxevQpAbXp/k86'
    CLOUDFLARE_EMAIL: 'CiQA3c2SSLaVRPtLd1Q/aHbmAons0r9Pz8WZ5PSP44cYvsBDMjASPgAp5JKp1uj6sUuEp6zC2rjhx5y3WWzHKLN3OegAUbbLX91+ILjmQhw5r462IJ1+OV/2IR+0/xGI9msuV+Ox'
    CLOUDFLARE_TOKEN: 'CiQA3c2SSPnpcQ426Wnw1qae3pBCKzZWMkwNxGB8FEy6vtB5jmASTgAp5JKp5dkHySbEDIi7mEjKPVDnZTsd4K2Ozn84qiO+g0TD64rdqT7tX7ljAzE3Ad/MRSJc5CgLWdm7HgAn6iONnHLVfjHZ1haNhlzMaA=='
    CLOUDFLARE_API_KEY: 'CiQA3c2SSPnpcQ426Wnw1qae3pBCKzZWMkwNxGB8FEy6vtB5jmASTgAp5JKp5dkHySbEDIi7mEjKPVDnZTsd4K2Ozn84qiO+g0TD64rdqT7tX7ljAzE3Ad/MRSJc5CgLWdm7HgAn6iONnHLVfjHZ1haNhlzMaA=='
    VAULT_ADDR: 'CiQA3c2SSKFN/sjdQqHyuhEn82CbCVM4XeWFhrTfUDTia/BgSoISRQAp5JKpiYHsPy1kaenVXu4IGYVNgtgQScfg+Antx+GKmzNYN6rsHn+8vmMrhlKHWLlM4vNECWqf0WSvOQKwBR7MlPJoMA=='
    VAULT_TOKEN: 'CiQA3c2SSCIWn45HagZ7aBZeVFQPq/Vk4kdFvujtmsvPP2M61dgSQwAp5JKpWUrb1JvDtoXwv08pcyEoKMwCtKwyO5P02oO2OA+yZAz7CX8Hu5sm1Y+tyBWJAX0QHDWGoMtHL1WoCwG7ONI='
    SSH_KEY: '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'

timeout: '1200s'
