steps:
- name: 'gendall/docker'
  args: ['build', '-t', 'gcr.io/gendall-447f96/app:$TAG_NAME', '.']

- name: 'gendall/docker'
  args: ['push', 'gcr.io/gendall-447f96/app:$TAG_NAME']

- name: 'gendall/terraform'
  args: ['init', '-backend-config=bucket=gendall-447f96-terraform', '-backend-config=prefix=$_ENV']

- name: 'gendall/terraform'
  args: ['apply', '-var=project=gendall-447f96', '-var=env=$_ENV', '-var=output=inventory']
  secretEnv: ['DIGITALOCEAN_TOKEN', 'CLOUDFLARE_EMAIL', 'CLOUDFLARE_TOKEN', 'CLOUDFLARE_API_KEY', 'SSH_KEY']

- name: 'gendall/ansible'
  args: ['-i', 'inventory/hosts', 'deploy.yml']
  env: ['PROJECT_NAME=chatter-web', 'PROJECT_GROUP=chatter', 'TAG=$TAG_NAME', 'ENV=$_ENV']
  secretEnv: ['VAULT_ADDR', 'VAULT_TOKEN', 'SSH_KEY']

secrets:
- kmsKeyName: 'projects/gendall-447f96/locations/global/keyRings/cloudbuild/cryptoKeys/auth'
  secretEnv:
    DIGITALOCEAN_TOKEN: 'CiQA3c2SSJ8skxXSMlB9W8WkDhPSsDY11u+4mkDij/HfrcPBr9USaAAp5JKp9EKGTW2IGXSQL9P++yRv/sZNvt3DOvOy22XMaMw653y72gnmrJHxdj7VNo2Mrzt51W7Ut5GiNIC45B3+zUOObCy4at9QoQLnpefNjyVYE7201sjT3ibwl8ucnkj1MJdAx1xq'
    CLOUDFLARE_EMAIL: 'CiQA3c2SSMqpw9AJ9wCbWrJzi8Lhdj+1ysDldwPPFrB5FpJFx38SPgAp5JKpuzOoLp0mAhE97/qnktzxEIBQeQ1m4cNmLyFXzN26+v8uWVZzbJVsopBNoIGDY9sAqvAbgfDtmqcT'
    CLOUDFLARE_TOKEN: 'CiQA3c2SSJIFg3kvFF0sVAy+5DwyvEZF2NDGXXktcq7i1pLmFjgSTgAp5JKphiQfr8PiZvR78A00QobsqajTkATCDbkFIWy3q13Bp7lAmJbYlDzhipfrCUxIEP2kVSBwq9S6cBGSysTCxbPAtFDXPx/EV27Dbw=='
    CLOUDFLARE_API_KEY: 'CiQA3c2SSJIFg3kvFF0sVAy+5DwyvEZF2NDGXXktcq7i1pLmFjgSTgAp5JKphiQfr8PiZvR78A00QobsqajTkATCDbkFIWy3q13Bp7lAmJbYlDzhipfrCUxIEP2kVSBwq9S6cBGSysTCxbPAtFDXPx/EV27Dbw=='
    VAULT_ADDR: 'CiQA3c2SSKCUsxdWkN8dzSm9Z2FFHUuBiuTN0DfRow/AZ6qxOawSRQAp5JKpIzaecr1BFAOzyVo03jeoGJ/EtAV9Tg5vmluEtcfPzviAvWW8EtpiAr1RbHN4rpJSSYdEvNSVME7lM8Vz+qFBpw=='
    VAULT_TOKEN: 'CiQA3c2SSEMg7umVe+uersnUoBg4EaWhaYMpUQ8/teQfq/+HGEkSQwAp5JKpAKVLg8Z6Zc0amcwnJ7hbSon9v5AHE9aAGy10FnQHex4POkd0bfwHv7V7u1HdjWbkwmjej767s4Uq/aqTob8='
    SSH_KEY: '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'

timeout: '1200s'
