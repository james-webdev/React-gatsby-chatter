steps:
- name: 'gendall/docker'
  args: ['build', '-t', 'gcr.io/gendall-447f96/app:$TAG_NAME', '.']

- name: 'gendall/docker'
  args: ['push', 'gcr.io/gendall-447f96/app:$TAG_NAME']

- name: 'gendall/terraform'
  args: ['init', '-backend-config=bucket=gendall-447f96-terraform', '-backend-config=prefix=$_ENV']

- name: 'gendall/terraform'
  args: ['apply', '-var=project=gendall-447f96', '-var=env=$_ENV', '-var=output=inventory']
  secretEnv: ['GOOGLE_CREDENTIALS', 'DIGITALOCEAN_TOKEN', 'CLOUDFLARE_EMAIL', 'CLOUDFLARE_TOKEN', 'CLOUDFLARE_API_KEY', 'SSH_KEY']

- name: 'gendall/ansible'
  args: ['-i', 'inventory/hosts', 'deploy.yml']
  env: ['PROJECT_NAME=chatter-web', 'PROJECT_GROUP=chatter', 'TAG=$TAG_NAME', 'ENV=$_ENV']
  secretEnv: ['VAULT_ADDR', 'VAULT_TOKEN', 'SSH_KEY']

secrets:
- kmsKeyName: 'projects/gendall-447f96/locations/global/keyRings/cloudbuild/cryptoKeys/auth'
  secretEnv:
    GOOGLE_CREDENTIALS: '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'
    DIGITALOCEAN_TOKEN: 'CiQA3c2SSOu0c1OUfoc61xZaQ+kut3S4vkoQ/lGz2dj2ilSgPyESaAAp5JKp7uyPgnnI66YFyHY5CyYhuS3/bwe9pm65nLmJelEn9SfR6js+p3Wa5tVy5MJmUNMBpc6rOCdnEI1YhWQkffu0Wr/GGcMH6qYvTe6wi0s8MjYJK8QwwTjVGp/u6FXS5PLS/qAo'
    CLOUDFLARE_EMAIL: 'CiQA3c2SSL2SQlTU3poGaRNXf+JasU3cHGyO2k6XWziOGHwZXcISPgAp5JKp+wEcZZsbDwZNu/7/l3P7hhBMAbg7o3lMiBWspi3TSIpay1el6GtkJgUmLSvuA7rPlf4xBxe1xjDC'
    CLOUDFLARE_TOKEN: 'CiQA3c2SSH9R4PlUt0Lz17K0/0KDINdUl5fg+64jvgkDqja209sSTgAp5JKp88sQpip87by7OLLhB8kK1EwdU5+DUefEIaAE9dQToJm4dVbY3Xzkn4EjRXmIPPONGg04yts2Wa/qjFqpo156uRVA8EJamDx8pQ=='
    CLOUDFLARE_API_KEY: 'CiQA3c2SSH9R4PlUt0Lz17K0/0KDINdUl5fg+64jvgkDqja209sSTgAp5JKp88sQpip87by7OLLhB8kK1EwdU5+DUefEIaAE9dQToJm4dVbY3Xzkn4EjRXmIPPONGg04yts2Wa/qjFqpo156uRVA8EJamDx8pQ=='
    VAULT_ADDR: 'CiQA3c2SSInP8CLNmfUwlIXVuNMkJnuFWtSvIT6Xg9FqIemnfZgSRQAp5JKpZvF0kXrYinmGrilmfVTmglMzyHjT/Ogs2YPSbW1iXV8Ec5fXNmPSAx7NIhLYf+ZEq4E0naL+yiKbBnBhkraPJA=='
    VAULT_TOKEN: 'CiQA3c2SSAvM6Yap2eqxlRY7/A93llsPNFqhlzLredwrGhTm/BESQwAp5JKpncc6ZMKeF8QBkjfrubHhNKW2WU5ikoAImLb5PFBqSj5sH6b4YVLoj+V/pnbKityHE38Ej2WHEN7zs9WmQHE='
    SSH_KEY: 'CiQA3c2SSCRFTl3L5ORpTD8hid6PvU2BTxikBw+8mUS2Np3GhwsSuQ0AKeSSqbxfqCpA60zSrUQ8eBBdAIB2uFHPhmM2cUWyb9WYiTLbNYa2HHvoSrGxh3EgBc9UzX3wH5TsXAtmMzPWPj4X4+FsmFr11z/a0w5KQPQku6sVYBOzfFLXsk1B3mFjn37Z29f/HMUE0m1+Ce3MdWwD6DWHiqTVecu+3ECUVelV9YyGfl54OgUCIV4DVPH0Io4AjxY82J1Ni2Mlt5rWFifsBeOufZJzuFbirC/qROTFaqYCoHNtv1PSRdPR0MfKd2mmXzFNVhUSBXWw1NzmI3TEUFrn3x90LwuM2TVw3FJ0+/BMF3I08TK/imj2P2bMgE57E+1CtfGlwvDp6h39QYLlZL3oEQGnTYR8leIZg0PEOCUOaPGYf/bPUqfFdlG1jiMIjEXokYKQPZ6BSHejaVsrMGilBxN1ChdRsdg77RfakkpB60Lo6S4miaplIj9E3JJCTykj0NXpSauA2wOLe0PPrdcICG1ZUQ4XsVnaSuA75OPgkeAsdoUY+QaRVJz42LorvH0wxYWWSOpPBa89EX9kGBOdRyy76iw5kZKv09VHvWRDfnC2Xus/KoJj8jdmI159N9nRNo01dK7C6yChVvE6k+uD6gvzIB2pbyiihw28ETtumWMlLCFc+zJPoUvr8a3j3SYTSSZzc2jYnxfA6AkutT9HpF8at9iyotIlh/vCnGEWhWDayUHjnF2DlKpBK0/GtFTK4qf299Zge08xrFJWWYeXjnzym5TnWFXpcQS/vIQ2OJJv+pBIshhuSQHKQA10LtHEQsh1R4rT4/htQJ7Ud4rfrP6hnyJoQcIaduDGuJR0HMR7fotmsE7Dj+XszMud3g/kuhe699Ecofu0Q7z1ajVQkheRGTHT3wDGEJFmVFZ3c7yarZ8x+jbBNuWh1Woasi+JUOrWDJkxyBa4/h0O0IGhPXWBnGSiA3OH2rRa0pI16O3F90YpP99ID/fB268qhSjrefK5u7iMW0SxPeC6TMg9xoXGx7e19BdpksgGuxpR3qEO59w0TJO778NlY7Fy3pmy4b78amEHAiPPNbIS1vXaf9QwiCdPVfjnz/UCrtAGJnDjCC0eUQHPS15xtAQPwhxCtk5CRSh4WNgDjb6z5bNuyT6HVFM5KE5RCX/iVRNgAtGWBDCSKY1ct+sSEFAW9jaf9OmqZSR+pKYG2RX23mJf3M40c//YyywPKTl0n93n47aG2cUblaAb7yMw3CN2/eWF11OBi4eCczDdTHCThmpeGezCQ8KP0zJ1wL86NVMbxYxxe07f+43UwAQBavoBp/dqbIq9B6onw8G3xSPYj9a0rS2BRcsmlWaYAIJ5922qYT9V7n9YuGfeY9eRqncTw9QHGyuRZySKUGiiOZraU4QDpaJZt9ayk5r3WmRlg7/ZJqo/vGgxxQEA2Yid8V+/twqH82taPfwHOmsu/NKnvqpbMMTo+PRoltOLBJ2rIpPvl/V5VWPO/XNLsH5iXiGYo16nITPl0SlqTZqqe5xpW2/pFLaxzJrJOAk81WO0qhvxA0CBrZRbXyhvF7vrPbnjv7F6PAaaUHNsCSRwvwpjNDb4CKKdi/T7waB6ji6JpUCbYtqGPBbxbDadq5OnTzyMdMO+ysJdSVhuLBdeo1tifEGkHGV3CTJUgBjD7C5g0vF5HLKOGL77wTzNcyENaibSEFfQjaIwFxLf0FEr2T+vfJFrs6M3+70sj10ztcCdBpSAR0NM9yb1b4lzwfYsIanFbU0FM4qHwQIxMQk+UXiOMqhniOjATdCFz6L4ir2cW9SZkefox2brHbDSDP75ewkvkM6cpIOQyqazioJd4pqzCivKf6BP1gO1KrC6Iyi2SwsNmlfyseDky56vX8OOAmwCKcEQvs2u4wgUIL1jI+bSmJ0kfylGXLBXYoigyJQrWHnisZkj9XJjMjN0ih4EAC4Ii+2soVGB6lqhzaC3tUDHrDE8W1xipZYOsz/uL2BRwZBQlG9pxNw8CU2/pCVwsalwjBGaS3Jpdz7GSYPvjYR7L4pE6CixCAwjWTNIsm504hCDIjM1lGLcMMwPotfnShh5+W8Gox4rQIwA1HMCAO1sXIweCcuSop5Gh8UmGYdwzssgQN0nFFwgapT6FzYtnmNZNVyKJ0Ml7F2e6pvYfaKRIX/OJDmfp1mMZX0C7F2wLVVh3YWIUyJoGrNFApXR49qlGkIKkX9LJhMz5tok6YUiWO9pUGkfKAocyGN0qTfgdfWiA/2wgHo6Lwx40OTBZe6IpG9+WMNYHkPRygK9Tkeyopt4ltre+PTa0Y9XL+dw1wNOfQL6mQ=='

timeout: '1200s'
