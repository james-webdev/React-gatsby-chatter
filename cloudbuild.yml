steps:
- name: 'gendall/docker'
  args: ['build', '-t', 'gcr.io/gendall-447f96/app:$TAG_NAME', '.']

- name: 'gendall/docker'
  args: ['push', 'gcr.io/gendall-447f96/app:$TAG_NAME']

- name: 'gendall/terraform'
  args: ['init', '-backend-config=bucket=gendall-447f96-terraform', '-backend-config=prefix=$_ENV']

- name: 'gendall/terraform'
  args: ['apply', '-var=project=gendall-447f96', '-var=env=$_ENV', '-var=output=inventory']
  secretEnv: ['DIGITALOCEAN_TOKEN', 'CLOUDFLARE_EMAIL', 'CLOUDFLARE_TOKEN', 'CLOUDFLARE_API_KEY', 'SSH_KEY']

- name: 'gendall/ansible'
  args: ['-i', 'inventory/hosts', 'deploy.yml']
  env: ['PROJECT_NAME=chatter-web', 'PROJECT_GROUP=chatter', 'TAG=$TAG_NAME', 'ENV=$_ENV']
  secretEnv: ['VAULT_ADDR', 'VAULT_TOKEN', 'SSH_KEY']

secrets:
- kmsKeyName: 'projects/gendall-447f96/locations/global/keyRings/cloudbuild/cryptoKeys/auth'
  secretEnv:
    DIGITALOCEAN_TOKEN: 'CiQA3c2SSOu0c1OUfoc61xZaQ+kut3S4vkoQ/lGz2dj2ilSgPyESaAAp5JKp7uyPgnnI66YFyHY5CyYhuS3/bwe9pm65nLmJelEn9SfR6js+p3Wa5tVy5MJmUNMBpc6rOCdnEI1YhWQkffu0Wr/GGcMH6qYvTe6wi0s8MjYJK8QwwTjVGp/u6FXS5PLS/qAo'
    CLOUDFLARE_EMAIL: 'CiQA3c2SSL2SQlTU3poGaRNXf+JasU3cHGyO2k6XWziOGHwZXcISPgAp5JKp+wEcZZsbDwZNu/7/l3P7hhBMAbg7o3lMiBWspi3TSIpay1el6GtkJgUmLSvuA7rPlf4xBxe1xjDC'
    CLOUDFLARE_TOKEN: 'CiQA3c2SSH9R4PlUt0Lz17K0/0KDINdUl5fg+64jvgkDqja209sSTgAp5JKp88sQpip87by7OLLhB8kK1EwdU5+DUefEIaAE9dQToJm4dVbY3Xzkn4EjRXmIPPONGg04yts2Wa/qjFqpo156uRVA8EJamDx8pQ=='
    CLOUDFLARE_API_KEY: 'CiQA3c2SSH9R4PlUt0Lz17K0/0KDINdUl5fg+64jvgkDqja209sSTgAp5JKp88sQpip87by7OLLhB8kK1EwdU5+DUefEIaAE9dQToJm4dVbY3Xzkn4EjRXmIPPONGg04yts2Wa/qjFqpo156uRVA8EJamDx8pQ=='
    VAULT_ADDR: 'CiQA3c2SSInP8CLNmfUwlIXVuNMkJnuFWtSvIT6Xg9FqIemnfZgSRQAp5JKpZvF0kXrYinmGrilmfVTmglMzyHjT/Ogs2YPSbW1iXV8Ec5fXNmPSAx7NIhLYf+ZEq4E0naL+yiKbBnBhkraPJA=='
    VAULT_TOKEN: 'CiQA3c2SSAvM6Yap2eqxlRY7/A93llsPNFqhlzLredwrGhTm/BESQwAp5JKpncc6ZMKeF8QBkjfrubHhNKW2WU5ikoAImLb5PFBqSj5sH6b4YVLoj+V/pnbKityHE38Ej2WHEN7zs9WmQHE='
    SSH_KEY: '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'

timeout: '1200s'
